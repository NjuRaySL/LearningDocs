# 项目介绍

一个可以进行好物分享展示与闲置交易实现的交流平台，集成了......

实现了排行榜功能、

启发在学校的一些闲置物品交易群，大家可以在里面售卖自己的闲置物品，其他人看到了也可以咨询购买。但是由于管控不严格，很多非法分子冒充校内学生发布假的物品，来骗学生。还有消息比较冗杂没有分类，导致在群里一眼望去乱七八糟的什么东西都有，很难挑到自己想要的。所以我们以此为契机，开发了一个能够管控人员，物品发布，完成闲置交易沟通，以及好物分享等额外功能的平台。

一开始是有打算能够在平台上完成下单支付交易功能，但是由于这块相对比较敏感，学校那块管控也比较严，我们作为私人的开发是比较受限的，所以这部分就空出来没有开发，后续如果有机会的话是会尝试加上去的。

# 架构篇

## 角色权限划分

角色分为三类：

- 资源发布者，也可以称为卖家。
- 信息浏览者，也是买家。
- 管理员，实现系统管理。

## 功能划分

- 用户侧：登录注册，身份识别，个人中心，关注/被关注
- 闲置帖：管理：增删改查、点赞收藏、计数统计、分类标签、评论
- 好物帖：管理、运营
- 消息通知：消息中心、消息触达
- 搜索，推荐功能

所以综上划分为9个模块：

![image-20240808095326895](C:\Users\l50039653\Desktop\Doc\Pics\image-20240808095326895.png)

### **登录功能**具体实现

采用微信公众号的方式实现，适用于个人公众号

### **消息通知功能具体实现**

采用异步驱动，通过Event/Listener方式来实现解耦

![image-20240808095752387](C:\Users\l50039653\Desktop\Doc\Pics\image-20240808095752387.png)

## 整体架构

- **整体架构图如下：**

![image-20240808100056396](C:\Users\l50039653\AppData\Roaming\Typora\typora-user-images\image-20240808100056396.png)

**技术架构图如下：**

![image-20240808100202329](C:\Users\l50039653\AppData\Roaming\Typora\typora-user-images\image-20240808100202329.png)

# 技术篇

## 类别划分

### 前端：

- 采用Thymleaf模板引擎进行视图渲染
- 只用会基本的html,css,js即可

### 管理后台侧：

- 采用成熟的前后端分离技术方案
- 前端基于react成熟框架搭建

### 业务应用侧：

**应用侧：**

- **文章 专栏 评论 用户 收藏 订阅** 运营 审核 类目标签 统计

**服务侧：**

通用的、可抽离业务属性的功能模块，沉淀到服务层

- **用户权限管理（auth）**
- **消息中心 (mq）**
- **计数 (redis)**
- **搜索服务 (es)**
- **推荐 (recommend)**
- 监控运维 (prometheus)

**平台资源侧：**

这一层可以理解为更基础的下层支撑 

- 服务资源：数据库、redis、es、mq 
- 硬件资源：容器，ecs服务器

## 用户模块

### 登录实现

#### 登录方式流程

**选择微信公众号登录方式：**

- 点击登录，**登录页显示二维码 + 验证码 -> 用户关注公众号，将登录页面上的验证码输入到微信公众号 -> 自动登录**

- 代码实现简单，逻辑清晰。但是操作流程复杂，用户需要输入两次

**登录流程图：**

![image-20240808101904638](C:\Users\l50039653\Desktop\Doc\Pics\image-20240808101904638.png)

#### **库表设计**

~~~sql

~~~

我们冗余了 user_name , password 用户名密码的登录方式，主要是给管理员登录后台使用

用户首次登录之后，会在user表中插入一条数据，**主要关注 third_account_id 这个字段，它记录的是微信开放平台返回的唯一用户id**

### 权限管理

权限管理会分为两块：**用户身份识别 + 鉴权**

#### **身份识别**

**cookie + session 方式（后续会迭代为分布式session + jwt）**

![image-20240808102648516](C:\Users\l50039653\AppData\Roaming\Typora\typora-user-images\image-20240808102648516.png)

服务内部身份传递：

**我们采用的单体架构而言，借助ThreadLocal来实现**：

- **自定义Filter，实现用户身份识别**（即上面的流程，从cookie中拿到SessionId，转 userId)
- 定义全局上下文ReqInfoContext：**将用户信息，写入全局共享的ThreadLocal中**
- 在系统内，需要获取当前用户的地方，**直接通过访问 ReqInfoContext上下文获取用户信息**
- **请求返回前，销毁上下文中当前登录用户信息**

#### 鉴权

我们设计三种权限点类型 

- ADMIN：只有管理员才能访问的接口 
- LOGIN：只有登录了才能访问的接口 
- ALL：默认，没有权限限制

需要权限判定的**接口上，添加上对应的权限要求**，**然后借助AOP来实现权限判断**

#### 库表设计

~~~sql

~~~

### 业务逻辑

#### 订阅关注

订阅关注这块业务主要是用户可以相互关注，核心在维护用户之间的订阅关系

**库表设计：**

~~~sql

~~~

#### 用户行为追踪

记录用户的阅读历史，关注列表，收藏列表，评价的帖子列表等。

设计目的：

- 记录用户的关键动作
- 便于文章的相关计数

库表设计：

~~~sql

~~~

**将用户 + 文章设计唯一键，用来记录用户对自己阅读过的文章的行为**，因此可以直接通过这个表获取用户的历史轨迹

## 帖子模块

**我们将文章和专栏都放在一起，同样也将类目管理、标签管理**等也都放在这个模块

### 文章

#### **发布流程：**

1. 用户登录，进入发布页
2. 输入标题，文章
3. 选择分类，标签，封面，简介
4. 提交文章，进入待审核，仅限自己查看
5. 管理员审核通过都可查看

#### **库表设计：**

- 在很多的业务场景中，我们实际上是不需要文章内容的，如首页、推荐列表等都只需要文章的标题等信息；
- 此外我们也希望对文章做一个版本管理（比如上线之后，再修改则新生成一个版本）

- 因此我们对文章设计了两张表：

~~~sql

~~~

~~~sql

~~~

- 文章对应的分类，我们要求一个文章只能挂在一个分类下

~~~sql

~~~

- 文章对应的标签属性，一个文章可以有多个标签

~~~sql

~~~

### 专栏

#### 内容描述

是一系列文章的合集，基于此最简单的设计方案就是加一个专栏表，然后再加一个专栏与文章的映射表

#### **专栏表设计：**

~~~sql

~~~

#### **专栏文章表设计：**

~~~sql

~~~

### 点赞收藏

#### 内容描述

点赞与收藏，实际上就是用户与文章之间的操作行为，再前面的 user_foot 表就已经介绍具 体的表结构, 文章的统计计数就是根据这个表数据来的，当前用户与文章的点赞、收藏关系， 同样是根据这个表来的。

唯一需要注意的点，**就是这个数据的插入、更新策略：**

- 首次阅读文章时：插入一条数据 
- 点赞：若记录存在，则更新状态，之前时点赞的，设置为取消点赞；若记录不存在，则插入一条点赞的记录 
- 收藏：同上

### 评论

#### 内容描述

评论可以是针对文章进行，也可以是针对另外一个评论进行回复，我们将回复也当作是一个评论

![image-20240808163244278](C:\Users\l50039653\Desktop\Doc\Pics\image-20240808163244278.png)

- 将评论和回复都当成普通的评论，只是主体不同而已
- 要重点关注的就是，如何构建评论与其回复之间的层级关系

**解决办法：是表内的父子关系来处理**

- 每个评论记录它的上一级评论id（若只是针对文章的评论，那么上一级评论id = 0） 
- 我们通过父子关系，在业务层进行逻辑还原

#### **库表设计：**

~~~sql

~~~

**为什么再表中需要冗余一个顶级评论id ？** 

- 主要的目的是简化业务层评论关系还原的复杂性

1. 先查出文章的顶级评论（parent_comment_id = 0） 
2. 接下来就是针对每个顶级评论，查询它下面的所有回复 ( top_comment_id = comment_id)  
3. 构建顶级评论下的回复父子关系（根据parent_comment_id来构建依赖关系）

### 评论点赞

#### 内容描述

技术派中同样支持对评论进行点赞，取消点赞；对于点赞的整体业务逻辑操作，实际上与文章的点赞一致，因此我们直接复用了文章的点赞逻辑，借助 user_foot 来实现的

## 消息模块

### 内容描述

是记录一些定义的事件，用于同步给用户；**我们整体采用Event/Listener的异步方案来进行**

- 在单机应用中，借助 Spring Event/Listener 机制来实现；
- 在集群中，将借助MQ消息中 间件来实现；

![image-20240808095752387](C:\Users\l50039653\Desktop\Doc\Pics\image-20240808095752387.png)

当发生方面的行为之后，再相应的地方进行主动埋点，手动发送一个消息事件，然后异步消费 事件，生成消息通知

需要注意一点： 

- 当用户点赞了一个文章，产生一个点赞消息之后；又取消了点赞，这个消息会怎样？ 
- **撤销还是依然保留？（技术派中选择的方案是撤销）**

### 库表设计

~~~sql

~~~

## 通用模块

### 统计计数

#### 内容描述

针对文章的阅读计数，没访问一次计数+1， 因此前面的 user_foot 不能使用

- **（因为未登录 的用户是不会生成user_foot记录的）**

#### 库表设计

~~~sql

~~~

上面这个计数表中的cnt的更新，**使用 cnt = cnt + 1 而不是 cnt = xxx 的方案**

### pu/uv

#### 内容描述

每天的请求pv/uv计数统计，直接在filter层中记录

#### 库表设计

~~~sql

~~~

### 全局字典

#### 内容描述

统一配置、全局字典相关的，主要是减少代码中的硬编码

#### 库表设计

~~~sql

~~~

### 图片上传

#### 内容描述

文章的图片上传，我们支持服务器本地存储和oss存储，

- 其中dev开发环境，默认是本地存储，即图片传到本地的一个目录下；
- prod生产环境，会将图片上传到阿里云的oss（其他厂商 的oss也没有什么本质区别，都是一个post请求，将文件上传而已）；

**注意：**

- 具体的实现中，需要**自动检测文章中的图片，进行转存，避免直接引入外部的资源**，导致失效问题
- 下载外网资源，是否会有安全问题？  
- - 采用资源类型限制、校验 
  - 生产环境中不存储资源到本地服务器/或者限制本地存储的文件名
- 下载外网资源，转存是否会导致整个文章发布过程很慢？ 
- - 并发转存策略

### 推荐搜索

技术派当前的搜索推荐主要是基于数据库来实现

**后续再介绍es相关教程时，会同步引入ES 进行替换当前的数据库方案**
